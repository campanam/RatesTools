# RatesTools Pipeline Details  

__Michael G. Campana & Ellie E. Armstrong, 2019-2020__  
Smithsonian Conservation Biology Institute  
Stanford University  

The following document provides detailed descriptions of the steps included in the RatesTools pipeline. Please note that the commands shown below only list non-standard options for clarity. We omit basic input/output required for these commands. See the documentation for these programs for operation details.  

## prepareRef  
The prepareRef process indexes the reference sequence using `bwa index` (and optionally the specified indexing algorithm) and `samtools faidx`. It also generates a sequence dictionary using `samtools dict`.

## alignSeqs  
The alignSeqs process aligns read pairs (in two separate fastq format files) against the indexed reference sequencing using `bwa mem` and converts to bam format using `samtools view` to conserve disk space.  

## sortBAM  
The sortBAM process sorts the bam files from alignSeqs using `samtools sort`. This process was separated from the alignSeqs step to minimize redundant calculations should there be an error necessitating pipeline resumption.  

## markDuplicates  
The markDuplicates process marks PCR duplicates using either `sambamba markdup` or Picard MarkDuplicates (`java -jar picard.jar MarkDuplicates MAX_FILE_HANDLES_FOR_READ_ENDS_MAP=1000`).  

## fixReadGroups  
The fixReadGroups process adds sample read group information to the bam files using Picard AddOrReplaceReadGroups (`java -jar picard.jar AddOrReplaceReadGroups`).  

## realignIndels  
The realignIndels process first builds a bam index (.bai) for the fixReadGroups output bam using Picard BuildBamIndex (`java -jar picard.jar BuildBamIndex`). It then identifies intervals for indel realignment using GATK RealignerTargetCreator (`java -jar GenomeAnalysisTK.jar -T RealignerTargetCreator`) and realigns indels using GATK IndelRealigner (`java -jar GenomeAnalysisTk.jar -T IndelRealigner --filter_bases_not_stored`).  

## filterBAMs  
The filterBAM process strictly filters aligned reads using GATK PrintReads following [1] (`java -jar GenomeAnalaysisTK.jar -T PrintReads --read_filter BadCigar --read_filter DuplicateRead --read_filter FailsVendorQualityCheck --read_filter HCMappingQuality --read_filter MappingQualityUnavailable --read_filter NotPrimaryAlignment --read_filter UnmappedRead --filter_bases_not_stored --filter_mismatching_base_and_quals`).  

## fixMate  
The fixMate process corrects sequence mate pair tags using Picard FixMateInformation (`java -jar picard.jar FixMateInformation ADD_MATE_CIGAR=true`). It then builds a bam index (.bai) for the output bam file using Picard BuildBamIndex (`java -jar picard.jar BuildBamIndex`).  

## callVariants  
The callVariants process calls individual sequence variants (gVCF format) using GATK HaplotypeCaller (`java -jar GenomeAnalaysisTK.jar -T HaplotypeCaller -A DepthPerSampleHC -A Coverage -A HaplotypeScore -A StrandAlleleCountsBySample -ERC GVCF -out_mode EMIT_ALL_SITES`).  

## genotypegVCFs  
The genotypegVCFs process performs joint-genotyping and generates an all-sites VCF for all samples using GATK GenotypeGVCFs (`java -jar GenomeAnalaysisTK.jar -T GenotypeGVCFs --includeNonVariantSites`).  It then compresses the resulting multi-sample VCF using `gzip`.  

## genMapIndex  
The genMapIndex process generates the GenMap index for the reference sequence for downstream mappability calculations (`genmap index`).  

## genMapMap  
The genMapMap process calculates the mappability for the reference sequence using GenMap (`genmap map -K 30 -E 2 -b`). It then filters the GenMap results using filterGM to exclude any sequences with mappability < 1.0 (`filterGM.rb <raw_genmap.bed> 1.0 exclude > <genmap.1.0.bed>`).  

## repeatMask  
The repeatMask process uses RepeatMasker to soft-mask repeat regions in the reference sequence based on a pre-defined target species (`RepeatMasker -gccalc -nolow -species <specified species>`). The soft-masked reference sequence is passed to the repeatModeler process.  

## repeatModeler  
The repeatModeler process uses RepeatModeler and the RepeatMasker soft-masked reference sequence to generate a species-specific repeat library for the reference sequence. First, a database is built using `BuildDatabase`, then the library is built using `RepeatModeler`. The resulting library (`consensi.fa.classified`) RepeatMasker -pa ${rm_pa} -gccalc -nolow -lib consensi.fa.classified is passed to the repeatMaskRM process.  

## repeatMaskRM  
The repeatMaskRM process uses RepeatMasker and the RepeatModeler custom repeat library to soft mask the reference sequence (`RepeatMasker -gccalc -nolow -lib consensi.fa.classified`). The RepeatMasker out file (.out) is then converted to bed using RM2bed (`RM2bed.rb <in.out> > <out.bed>`).  

## maskIndels  
Using indels2bed, the maskIndels process scans the all-sites VCF generated by the genotypeGVCFs process for indels and generates a bed file excluding all sites 5 bp upstream/downstream of the identified indels (`indels2bed.rb <all-sites.vcf> 5 > <indels.bed>`).  

## simplifyBed  
The simplifyBed process identifies and merges overlapping bed entries in the bed results from the repeatMaskRM, genMapMap and maskIndels processes. First, overlapping bed entries are merged for each of the three chromosome-sorted and coordinate-sorted bed files using simplify_sorted_bed (`simplify_sorted_bed.rb <in.bed> > <out.bed>`). The three merged bed files are then concatenated using `cat`. Overlapping entries in the resulting, unsorted bed file are merged using simplify_bed (`simplify_bed.rb <cat.bed> > <out_cat.bed>`).  

## filterChr  
Using VCFtools, the filterChr process generates all-sites VCFs for each offspring and its parents (`vcftools --recode --indv <sire> --indv <dam> --indv <offspring>`). The number of resulting VCFs will thus equal the number of offspring in the dataset. If a list of target chromosomes was provided, this process also filters the output VCFs to include only the specified target regions using the `--chr` option. The resulting VCFs are compressed using `gzip`.  

## splitVCFs  
The splitVCFs process splits each VCF generated during the filterChr process by chromosome/contig name for parallelization of downstream processes using nextflow_split (`nextflow_split.rb -i <in.vcf> -o <out_split_vcfs_dir>`. The resulting VCFs are compressed using `gzip`.  

## filterSites  
The filterSites process filters the split VCF files from the splitVCFs process using VCFtools and the site filters provided in the config file (`vcftools --recode <site_filters>`). The resulting VCFs are compressed using `gzip`.  

## filterRegions  
Using VCFtools, the filterRegions process removes low-reliability regions (repeat regions, indel-affected sites, and regions of non-unique mappability) from the site-filtered VCFs from the filterSites process. The low-reliability regions are specified in the output merged bed from the simplifyBed process (`vcftools --recode --exclude-bed <out_cat.bed>`). The resulting VCFs are compressed using `gzip`.  

## calcDNMRate 
Using the region-filtered VCFs output from the filterRegions process, the calcDNMRate process calculates the per-chromosome mutation rate using calc_denovo_mutation_rate and the options specified in the config file (`calc_denovo_mutation_rate.rb -i <chr.vcf> -s <sire> -d <dam> <denovo_mutation_options> > chr.log)`).  

## summarizeDNM  
Using `summarize_denovo.rb`, the summarizeDNM process combines the per-chromosome mutation rate results from the calcDNMRate process to obtain the genomic mutation rate.  

## References  
1. Besenbacher, S., Hvilsom, C., Marques-Bonet, T., Mailund, T., Schierup, M.H. (2019) Direct estimation of mutations in great apes reconciles phylogenetic dating. *Nat Ecol Evol*, __3__, 286-292. DOI: [10.1038/s41559-018-0778-x](https://www.nature.com/articles/s41559-018-0778-x).  

