manifest {

	name = 'RatesTools'
	author = 'Michael G. Campana, Ellie E. Armstrong'
	homePage = 'https://github.com/campanam/RatesTools'
	description = 'Pipeline to calculate de novo mutation rates'
	mainScript = 'ratestools.nf'
	version = '0.2.0'
	nextflowVersion = '>=20.10.0'

}

params {

	refseq = "$baseDir/ref.fa" // Reference sequence
	reads = "$baseDir/*{R1,R2}_001.fastq*" // Read pairs
	bwa_alg = "" // algorithm for BWA index. Value "" permits BWA to infer algorithm
	bwa_threads = 20 // Number of threads for BWA-MEM and SAMtools
	markDuplicates = "picard" // Choice of 'picard' or 'sambamba' for markDuplicates
	picard = "$baseDir/picard.jar" // Path for Picard jar file
	picard_java = "" // Java options for Picard
	gatk = "$baseDir/GenomeAnalysisTK.jar" // Path for GATK 3.8-1 jar file
	gatk_java = "" // Java options for GATK
	gatk_nct = 16 // Parallelization for GATK (when available)
	gm_tmpdir = '/tmp' // Scratch directory for GenMap indexing
	gm_threads = 8 // Number of GenMap threads
	rm_species = "Felidae" // Species name for RepeatMasker
	rm_pa = 24 // Number of parallel threads for RepeatMasker/RepeatModeler
	prefix = "test" // Prefix for final datasets
	outdir = "test_results" // Directory for final results
	dam = "SRR" // Sample name for dam
	sire = "SRR2" // Sample name for sire
	site_filters = "--minDP 30 --minGQ 65 --maxDP 250 --max-missing 1 --min-alleles 1 --max-alleles 2" // Site filters to pass to VCFtools
	chr_file = "$baseDir/chr.txt" // File listing chromosomes to keep in analysis. Set to "NULL" to ignore this filter. 
	dnm_opts = "-b 100 -M 10 -w 100000 -l 100000 -S 50000 --parhom" // options for calc_denovo_mutation_rate
	
}

modules {
	// List of Modules required for each executable. Set to "" for null value
	samtools = ""
	bwa = ""
	java = ""
	sambamba = ""
	gzip = ""
	genmap = ""
	ruby = ""
	RepeatMasker = ""
	RepeatModeler = ""
	vcftools = ""
	awk = ""
}

profiles {
	
	standard {
		process.executor = 'local'
		process.storeDir = 'chkpnt' // Prevent remaking completed files
		process.maxForks = 1000 // Prevent job submission overflow
		// Setting modules for each process separately to minimize dependency incompatibilities
		process {
			withName: prepareRef {
				module = [modules.samtools, modules.bwa].minus("")
			}
			withName: alignSeqs {
				module = [modules.bwa, modules.samtools].minus("")
			}
			withName: sortBAM {
				module = [modules.samtools].minus("")
			}
			withName: markDuplicates {
				module = [modules.java, modules.sambamba].minus("")
			}
			withName: fixReadGroups {
				module = [modules.java].minus("")
			}
			withName: realignIndels {
				module = [modules.java].minus("")
			}
			withName: filterBAMs  {
				module = [modules.java].minus("")
			}
			withName: fixMate {
				module = [modules.java].minus("")
			}
			withName: callVariants {
				module = [modules.java].minus("")
			}
			withName: genotypegVCFs {
				module = [modules.java,modules.gzip].minus("")
			}
			withName: genMapIndex {
				module = [modules.genmap].minus("")
			}
			withName: genMapMap {
				module = [modules.genmap,modules.ruby].minus("")
			}
			withName: repeatMask {
				module = [modules.RepeatMasker].minus("")
			}
			withName: RepeatModeler {
				module = [modules.RepeatModeler].minus("")
			}
			withName: repeatMaskRM {
				module = [modules.RepeatMasker,modules.ruby].minus("")
			}
			withName: maskIndels {
				module = [modules.ruby].minus("")
			}
			withName: simplifyBed {
				module = [modules.ruby].minus("")
			}
			withName: filterChr {
				module = [modules.vcftools,modules.gzip,modules.awk].minus("")
			}
			withName: splitVCFs {
				module = [modules.ruby].minus("")			
			}
			withName: filterSites {
				module = [modules.vcftools,modules.gzip].minus("")
			}
			withName: filterRegions {
				module = [modules.vcftools,modules.gzip].minus("")
			}
			withName: calcDNMRate {
				module = [modules.ruby].minus("")
			}
			withName: summarizeDNM {
				module = [modules.ruby].minus("")
			}
		}
	}
	
	hydra {
	 	// Parameters for the SI/HPC Hydra-5 UGE cluster. Hydra setup does not permit use of the process.cpus variable
	 	
	 	// Update modules
	 	modules.samtools = "bioinformatics/samtools/1.9"
		modules.bwa = "bioinformatics/bwa/0.7.17"
		modules.java = "java/1.8"
		modules.sambamba = ""
		modules.gzip = ""
		modules.genmap = ""
		modules.ruby = "bioinformatics/ruby/2.6.3"
		modules.RepeatMasker = "" // Hydra RepeatMasker module requires writing to restricted locations for databases
		modules.RepeatModeler = "" // Hydra modulefile loads unusable RepeatMasker
		modules.vcftools = "bioinformatics/vcftools/0.1.16"
		modules.awk = ""
	 	
	 	// Default clusterOptions for picard, vcftools and java commands
	 	params.picard_java = '-d64 -server -XX:MaxHeapSize=5G'
	 	params.gatk_java = '-d64 -server -XX:MaxHeapSize=5G'
	 	default_picard_options = "-l mres=6G,h_data=6G,h_vmem=6G -pe mthread 2 -S /bin/bash" // Extra thread for parallel GC
	 	default_gatk_options = "-l mres=6G,h_data=6G,h_vmem=6G,himem -pe mthread ${params.gatk_nct} -S /bin/bash"
	 	default_vcftools_options = "-l mres=5G,h_data=5G,h_vmem=5G -S /bin/bash"
	 	default_low_options = '-l mres=2G,h_data=2G,h_vmem=2G -S /bin/bash' // Options for low computation steps
	 	
		process.executor = 'sge'
		process.storeDir = 'chkpnt' // Prevent remaking completed files
		process.maxForks = 1000 // Prevent job submission overflow

		process {
			withName: prepareRef {
				queue = 'mThC.q'
				clusterOptions = '-l mres=6G,h_data=6G,h_vmem=6G -S /bin/bash'
				module = [modules.samtools, modules.bwa].minus("")
			}
			withName: alignSeqs {
				queue = 'mThC.q'
				clusterOptions = "-l mres=2G,h_data=2G,h_vmem=2G -pe mthread ${params.bwa_threads} -S /bin/bash"
				module = [modules.bwa, modules.samtools].minus("")
			}
			withName: sortBAM {
				queue = 'mThC.q'
				clusterOptions = "-l mres=2G,h_data=2G,h_vmem=2G -pe mthread ${params.bwa_threads} -S /bin/bash"
				module = [modules.samtools].minus("")
			}
			withName: markDuplicates {
				queue = 'mThC.q'
				clusterOptions = default_picard_options
				module = [modules.java, modules.sambamba].minus("")
			}
			withName: fixReadGroups {
				queue = 'mThC.q'
				clusterOptions = default_picard_options
				module = [modules.java].minus("")
			}
			withName: realignIndels {
				queue = 'mThC.q'
				clusterOptions = default_picard_options // Using picard options since not using gatk_nct
				module = [modules.java].minus("")
			}
			withName: filterBAMs  {
				queue = 'mThM.q'
				clusterOptions = default_gatk_options
				module = [modules.java].minus("")
			}
			withName: fixMate {
				queue = 'mThC.q'
				clusterOptions = default_picard_options
				module = [modules.java].minus("")
			}
			withName: callVariants {
				queue = 'lThM.q'
				clusterOptions = default_gatk_options
				module = [modules.java].minus("")
			}
			withName: genotypegVCFs {
				queue = 'lThC.q'
				clusterOptions = default_picard_options
				module = [modules.java,modules.gzip].minus("")
			}
			withName: genMapIndex {
				queue = 'mThM.q'
				clusterOptions = "-l mres=16G,h_data=16G,h_vmem=16G,himem -S /bin/bash"
				module = [modules.genmap].minus("")
			}
			withName: genMapMap {
				queue = 'mThM.q'
				clusterOptions = "-l mres=10G,h_data=10G,h_vmem=10G,himem -pe mthread ${params.gm_threads} -S /bin/bash"
				module = [modules.genmap,modules.ruby].minus("")
			}
			withName: repeatMask {
				queue = 'mThM.q'
				clusterOptions = "-l mres=1G,h_data=16G,h_vmem=16G,himem -pe mthread ${params.rm_pa} -S /bin/bash"
				module = [modules.RepeatMasker].minus("")
			}
			withName: repeatModeler {
				queue = 'mThM.q'
				clusterOptions = "-l mres=16G,h_data=16G,h_vmem=16G,himem -pe mthread ${params.rm_pa} -S /bin/bash"
				module = [modules.RepeatModeler].minus("")
			}
			withName: repeatMaskRM {
				queue = 'mThM.q'
				clusterOptions = "-l mres=16G,h_data=16G,h_vmem=16G,himem -pe mthread ${params.rm_pa} -S /bin/bash"
				module = [modules.RepeatMasker,modules.ruby].minus("")
			}
			withName: maskIndels {
				queue = 'mThC.q'
				clusterOptions = default_low_options
				module = [modules.ruby].minus("")
			}
			withName: simplifyBed {
				queue = 'sThC.q'
				clusterOptions = '-l mres=6G,h_data=6G,h_vmem=6G -S /bin/bash'
				module = [modules.ruby].minus("")
			}
			withName: filterChr {
				queue = 'lThC.q'
				clusterOptions = default_vcftools_options
				module = [modules.vcftools,modules.gzip,modules.awk].minus("")
			}
			withName: splitVCFs {
				queue = 'mThC.q'
				clusterOptions = default_low_options
				module = [modules.ruby].minus("")			
			}
			withName: filterSites {
				queue = 'lThC.q'
				clusterOptions = default_vcftools_options
				module = [modules.vcftools,modules.gzip].minus("")
			}
			withName: filterRegions {
				queue = 'lThC.q'
				clusterOptions = default_vcftools_options
				module = [modules.vcftools,modules.gzip].minus("")
			}
			withName: calcDNMRate {
				queue = 'lThC.q'
				clusterOptions = default_low_options
				module = [modules.ruby].minus("")
			}
			withName: summarizeDNM {
				queue = 'sThC.q'
				clusterOptions = default_low_options
				module = [modules.ruby].minus("")
			}
		}
	}

}
